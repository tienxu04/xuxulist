<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>Thư mục Sách — xuxu</title>
<style>
    /* ==== Material 3 · Matcha palette ==== */
    :root{
      --md3-primary: #6bae74;      /* matcha green */
      --md3-on-primary: #ffffff;
      --md3-primary-container: #d8efd9;
      --md3-on-primary-container: #0b3a18;

      --md3-secondary: #7e8f76;    /* herbal grey-green */
      --md3-on-secondary: #ffffff;
      --md3-secondary-container: #e1e9dc;
      --md3-on-secondary-container: #1e2a1b;

      --md3-surface: #f6f7f4;      /* warm paper */
      --md3-surface-variant: #e7efe6;
      --md3-on-surface: #1b1c1b;
      --md3-on-surface-variant: #475247;
      --md3-outline: #c6d6c7;

      --md3-error: #b3261e;
      --md3-on-error: #ffffff;

      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;

      --shadow-1: 0 1px 2px rgba(0,0,0,.06), 0 1px 3px rgba(0,0,0,.04);
      --shadow-2: 0 2px 6px rgba(0,0,0,.08), 0 6px 18px rgba(0,0,0,.06);
      --focus: 0 0 0 3px rgba(107,174,116,.35);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --md3-surface: #0f130f;
        --md3-on-surface: #e7eae6;
        --md3-surface-variant: #1b221c;
        --md3-on-surface-variant: #c8d5c9;
        --md3-outline: #384639;

        --md3-primary: #79c587;
        --md3-on-primary: #0b2b15;
        --md3-primary-container: #12361f;
        --md3-on-primary-container: #bfeac6;

        --shadow-1: 0 1px 2px rgba(0,0,0,.35);
        --shadow-2: 0 4px 18px rgba(0,0,0,.45);
      }
    }

    /* ==== Base ==== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color:var(--md3-on-surface);
      background:linear-gradient(180deg, var(--md3-surface) 0%, #fff 60%) fixed;
    }
    a{color:var(--md3-primary); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1080px; margin:88px auto 40px; padding:0 20px}

    /* ==== Top App Bar ==== */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: color-mix(in srgb, var(--md3-surface), #fff 30%);
      border-bottom:1px solid var(--md3-outline);
    }
    .topbar-inner{
      max-width:1080px; margin:auto; padding:14px 20px;
      display:flex; align-items:center; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:700;
      letter-spacing:.2px;
    }
    .brand .logo{
      width:36px; height:36px; border-radius:10px;
      display:grid; place-items:center;
      background:var(--md3-primary-container); color:var(--md3-on-primary-container);
      box-shadow: var(--shadow-1);
    }
    .brand h1{font-size:20px; line-height:1; margin:0}

    /* ==== Toolbar ==== */
    .toolbar{
      margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .textfield{
      position:relative; flex:1 1 420px; min-width:260px;
    }
    .textfield input[type="search"]{
      width:100%; padding:14px 44px 14px 44px;
      border:1px solid var(--md3-outline);
      border-radius: var(--radius-lg);
      background: var(--md3-surface-variant);
      color: var(--md3-on-surface);
      outline: none; box-shadow: var(--shadow-1);
      transition: border .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .textfield input[type="search"]::placeholder{color: color-mix(in srgb, var(--md3-on-surface), #000 30%); opacity:.6}
    .textfield input[type="search"]:focus{
      background:#fff; border-color: color-mix(in srgb, var(--md3-primary), #000 10%);
      box-shadow: var(--focus), var(--shadow-2);
    }
    .leading-icon, .trailing-icon{
      position:absolute; top:50%; transform:translateY(-50%);
      width:20px; height:20px; opacity:.7; pointer-events:none;
    }
    .leading-icon{left:14px}
    .trailing-btn{
      position:absolute; top:50%; right:8px; transform:translateY(-50%);
      width:28px; height:28px; border:none; border-radius:999px; background:transparent; color:inherit;
      display:grid; place-items:center; cursor:pointer;
    }
    .trailing-btn:hover{background: color-mix(in srgb, var(--md3-primary), #fff 85%);}
    .trailing-btn:focus-visible{outline:none; box-shadow: var(--focus)}

    .chip{
      padding:8px 12px; border-radius:999px;
      background: var(--md3-primary-container);
      color: var(--md3-on-primary-container);
      box-shadow: var(--shadow-1);
      font-size:13px;
    }
    .btn{
      border:none; border-radius: 999px; cursor:pointer;
      padding:10px 14px; font-weight:600;
      display:flex; align-items:center; gap:8px;
    }
    .btn.tonal{
      background: var(--md3-primary-container);
      color: var(--md3-on-primary-container);
      box-shadow: var(--shadow-1);
    }
    .btn.tonal:hover{filter:brightness(0.98)}
    .btn.tonal:active{filter:brightness(0.96)}
    .btn:focus-visible{outline:none; box-shadow: var(--focus)}

    /* ==== Card + Table ==== */
    .card{
      margin-top:18px; border-radius: var(--radius-lg);
      background: #fff; box-shadow: var(--shadow-2); overflow:hidden;
      border:1px solid var(--md3-outline);
    }
    .table-wrap{overflow:auto}
    table{border-collapse:collapse; width:100%; font-size:14.5px}
    thead th{
      position:sticky; top:0; z-index:1;
      background: var(--md3-surface-variant);
      color: var(--md3-on-surface);
      text-align:left; font-weight:700; letter-spacing:.2px;
      padding:12px 14px; border-bottom:1px solid var(--md3-outline);
      user-select:none; cursor:pointer;
    }
    tbody td{
      padding:12px 14px; border-bottom:1px solid color-mix(in srgb, var(--md3-outline), #000 10%);
      vertical-align:top;
    }
    tbody tr:hover{background: color-mix(in srgb, var(--md3-primary-container), #fff 70%)}
    .muted{opacity:.6}
    .sort-ind{font-size:11px; opacity:.8; margin-left:6px}
    .link-btn{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background: var(--md3-secondary-container);
      color: var(--md3-on-secondary-container);
      text-decoration:none; box-shadow: var(--shadow-1);
    }
    .link-btn:hover{text-decoration:none; filter:brightness(0.98)}

    /* ==== Progress (indeterminate) ==== */
    .progress{
      position:fixed; left:0; top:0; width:100%; height:3px;
      background:linear-gradient(90deg, transparent, color-mix(in srgb, var(--md3-primary), #fff 20%), transparent);
      transform: scaleX(0); transform-origin:left;
      transition: transform .2s ease;
      z-index:100;
    }
    body.loading .progress{ animation: indet 1.1s infinite linear }
    @keyframes indet{
      0%{transform:translateX(-30%) scaleX(.2)}
      40%{transform:translateX(20%) scaleX(.45)}
      100%{transform:translateX(120%) scaleX(.2)}
    }

    /* ==== Responsive tweaks ==== */
    @media (max-width: 720px){
      .topbar-inner{padding:12px 16px}
      .container{margin-top:76px}
      thead th, tbody td{padding:10px 12px}
    }
  /* Mobile polish chung */
:root{ --gap:10px }
body{ padding-bottom: env(safe-area-inset-bottom) }
.topbar{ padding-top: env(safe-area-inset-top) }

/* Bảng cuộn ngang mượt trên iOS */
.table-wrap{ overflow:auto; -webkit-overflow-scrolling:touch }
thead th, tbody td{ min-width:120px }  /* tránh vỡ chữ quá mức */

/* Input & chip co giãn tốt */
.toolbar{ display:flex; gap:var(--gap); flex-wrap:wrap }
.toolbar .textfield{ flex:1 1 280px; min-width:200px }
#count{ white-space:nowrap }

/* === Card view (<= 640px): bảng biến thành danh sách thẻ đọc dễ hơn) === */
@media (max-width:640px){
  table{ border-collapse:separate; border-spacing:0 10px }
  thead{ display:none }
  tbody{ display:block }
  tbody tr{
    display:block;
    background:#fff;
    border:1px solid var(--md3-outline);
    border-radius:14px;
    box-shadow: var(--shadow-1);
    padding:10px 12px;
    margin:10px 0;
  }
  tbody td{
    display:grid;
    grid-template-columns: 108px 1fr;   /* Nhãn | Nội dung */
    gap:8px;
    border-bottom:none !important;
    padding:8px 0 !important;
  }
  tbody td::before{
    content: attr(data-label);
    font-weight:600;
    color: var(--md3-on-surface-variant);
  }
  /* Ưu tiên hiển thị tiêu đề to hơn, nằm đầu thẻ */
  tbody tr td:first-child{ 
    grid-template-columns: 1fr; 
  }
  tbody tr td:first-child::before{ 
    content: none; 
  }
  tbody tr td:first-child{
    font-size:16px; font-weight:700; padding-top:2px;
    margin-bottom:4px;
  }
}
.sortgroup{ display:flex; gap:8px; align-items:center }
.sortgroup select{
  padding:10px 12px; border:1px solid var(--md3-outline);
  border-radius:12px; background:var(--md3-surface-variant);
}
#sortDir{ padding:10px 12px }
@media (max-width:640px){
  .toolbar{ width:100% }
  .sortgroup{ width:100% }
  .sortgroup select{ flex:1 }
}

  </style>
</head>
<body>
<div class="wrap">
  <h1>Thư mục sách</h1>
  <div class="small">Nguồn: Google Sheets (read-only)</div>

  <div class="toolbar">
    <input id="q" type="search" placeholder="Tìm theo tựa / tác giả / thể loại / quốc gia / review…" />
    <span class="count" id="count"></span>
  </div>
<div class="sortgroup">
  <select id="sortBy" aria-label="Sắp xếp theo">
    <option value="title">Tựa</option>
    <option value="genre">Thể loại</option>
    <option value="author">Tác giả</option>
    <option value="country">Quốc gia</option>
    <option value="review">xuxu review</option>
  </select>
  <button id="sortDir" class="btn tonal" type="button" aria-label="Đổi thứ tự">
    ↑ A–Z
  </button>
</div>

  <table id="table">
    <thead>
      <tr>
        <th data-key="title">Tựa</th>
        <th data-key="genre">Thể loại</th>
        <th data-key="author">Tác giả</th>
        <th data-key="country">Quốc gia</th>
        <th data-key="review">xuxu review</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
/** ====== CONFIG ====== **/
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTl4QUkDw2-np7Nc8jxJcbtXeDuFDnnXV85ClQENI-uR9UBicTGyD76rgnUlv-kCH8n5xBR49-92ky/pub?output=csv";

// Map cột trong Sheets -> field nội bộ
const headerMap = {
  "title": "Tựa",
  "genre": "Thể loại",
  "author": "Tác giả",
  "country": "Quốc gia",
  "review": "xuxu review"
};

/** ====== Helpers ====== **/
const diacriticless = s => (s||"")
  .toString()
  .normalize("NFD")
  .replace(/[\u0300-\u036f]/g, "")
  .toLowerCase();

function parseCSV(text) {
  // Parser CSV tối giản, hỗ trợ "ô có dấu phẩy/nháy"
  const rows = [];
  let i = 0, cur = [], cell = '', inQuotes = false;
  const pushCell = () => { cur.push(cell); cell = '' };
  const pushRow = () => { rows.push(cur); cur = [] };
  while (i < text.length) {
    const c = text[i];
    if (inQuotes) {
      if (c === '"') {
        if (text[i+1] === '"') { cell += '"'; i++; }
        else { inQuotes = false; }
      } else { cell += c; }
    } else {
      if (c === '"') inQuotes = true;
      else if (c === ',') pushCell();
      else if (c === '\r') { /* skip */ }
      else if (c === '\n') { pushCell(); pushRow(); }
      else cell += c;
    }
    i++;
  }
  if (cell.length || cur.length) { pushCell(); pushRow(); }
  return rows;
}

function rowsToObjects(rows) {
  if (!rows.length) return [];
  const header = rows[0].map(h => h.trim());
  return rows.slice(1).map(r => {
    const obj = {};
    header.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
    return obj;
  });
}

function mapRecord(rec) {
  const out = {};
  for (const key in headerMap) out[key] = rec[headerMap[key]] ?? "";
  return out;
}

function linkify(text) {
  if (!text) return "";
  const urlRegex = /(https?:\/\/[^\s)]+)|(www\.[^\s)]+)/gi;
  return text.replace(urlRegex, (m) => {
    const url = m.startsWith('http') ? m : 'http://' + m;
    return `<a href="${url}" target="_blank" rel="noopener">${m}</a>`;
  });
}

/** ====== State ====== **/
let data = [];
let filtered = [];
let sortState = { key: "title", dir: "asc" };

/** ====== Render ====== **/
const tbody = document.querySelector("#table tbody");
const countEl = document.getElementById("count");

function render() {
  tbody.innerHTML = "";
  filtered.forEach(row => {
    const tr = document.createElement("tr");

    // Tựa
    const tdTitle = document.createElement("td");
    tdTitle.textContent = row.title || "(Không tiêu đề)";
    tdTitle.dataset.label = "Tựa";
    tr.appendChild(tdTitle);

    // Thể loại
    const tdGenre = document.createElement("td");
    tdGenre.textContent = row.genre || "";
    tdGenre.dataset.label = "Thể loại";
    tr.appendChild(tdGenre);

    // Tác giả
    const tdAuthor = document.createElement("td");
    tdAuthor.textContent = row.author || "";
    tdAuthor.dataset.label = "Tác giả";
    tr.appendChild(tdAuthor);

    // Quốc gia
    const tdCountry = document.createElement("td");
    tdCountry.textContent = row.country || "";
    tdCountry.dataset.label = "Quốc gia";
    tr.appendChild(tdCountry);

    // xuxu review (tự linkify nếu có URL)
    const tdReview = document.createElement("td");
    tdReview.innerHTML = row.review ? linkify(row.review) : '<span class="muted">—</span>';
    tdReview.dataset.label = "xuxu review";
    tr.appendChild(tdReview);

    tbody.appendChild(tr);
  });

  // Đếm mục
  countEl.textContent = `${filtered.length} mục`;

  // Cập nhật aria-sort + mũi tên sort
  document.querySelectorAll("th[data-key]").forEach(th => {
    th.setAttribute("aria-sort", "none");
    const ind = th.querySelector(".sort-ind");
    if (ind) ind.remove();
  });
  const thActive = document.querySelector(`th[data-key="${sortState.key}"]`);
  if (thActive) {
    thActive.setAttribute("aria-sort", sortState.dir === "asc" ? "ascending" : "descending");
    const ind = document.createElement("span");
    ind.className = "sort-ind";
    ind.textContent = sortState.dir === "asc" ? "▲" : "▼";
    thActive.appendChild(ind);
  }
  syncSortUI();

}


function applyFilterAndSort() {
  const q = diacriticless(document.getElementById("q").value);
  filtered = data.filter(r => {
    const hay = [
      r.title, r.author, r.genre, r.country, r.review
    ].map(diacriticless).join(" ");
    return hay.includes(q);
  });

  const { key, dir } = sortState;
  filtered.sort((a, b) => {
    const va = a[key] ?? "";
    const vb = b[key] ?? "";
    const sa = diacriticless(String(va));
    const sb = diacriticless(String(vb));
    if (sa < sb) return dir === "asc" ? -1 : 1;
    if (sa > sb) return dir === "asc" ? 1 : -1;
    return 0;
  });

  render();
}

/** ====== Events ====== **/
document.getElementById("q").addEventListener("input", debounce(applyFilterAndSort, 120));
document.querySelectorAll("th[data-key]").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.getAttribute("data-key");
    if (sortState.key === key) sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
    else { sortState.key = key; sortState.dir = "asc"; }
    applyFilterAndSort();
  });
});

function debounce(fn, ms=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }

  const sortByEl  = document.getElementById("sortBy");
const sortDirEl = document.getElementById("sortDir");

function syncSortUI(){
  // đồng bộ UI với trạng thái hiện tại
  if (sortByEl) sortByEl.value = sortState.key;
  if (sortDirEl) sortDirEl.textContent = (sortState.dir === "asc") ? "↑ A–Z" : "↓ Z–A";
  if (sortDirEl) sortDirEl.setAttribute("aria-label", sortState.dir === "asc" ? "Đổi sang Z–A" : "Đổi sang A–Z");
}

if (sortByEl) {
  sortByEl.addEventListener("change", () => {
    sortState.key = sortByEl.value;
    sortState.dir = "asc";           // mỗi lần đổi cột, reset asc cho dễ hiểu
    applyFilterAndSort();
  });
}
if (sortDirEl) {
  sortDirEl.addEventListener("click", () => {
    sortState.dir = (sortState.dir === "asc") ? "desc" : "asc";
    applyFilterAndSort();
  });
}

/** ====== Boot ====== **/
(async function init() {
  try {
    const res = await fetch(CSV_URL);
    if (!res.ok) throw new Error("Không tải được CSV. Kiểm tra quyền Publish.");
    const text = await res.text();
    const rows = parseCSV(text);
    const objects = rowsToObjects(rows);
    data = objects.map(mapRecord);
    applyFilterAndSort();
  } catch (e) {
    alert("Lỗi tải dữ liệu: " + e.message);
    console.error(e);
  }
})();
</script>
</body>
</html>
