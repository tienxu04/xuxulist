<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Goodreads → Danh mục</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* ==== Material 3-ish Purple Theme ==== */
    :root{
      --m3-primary: #6a36f0;        /* tím đậm điểm nhấn */
      --m3-on-primary: #ffffff;
      --m3-surface: #f1d0ff;        /* lilac sáng (theo ảnh) */
      --m3-on-surface: #241537;     /* tím than cho chữ */
      --m3-surface-variant:#e3b8ff; /* bề mặt phụ */
      --m3-outline:#c99cff;         /* viền nhạt */
      --m3-shadow:#0000001a;
      --m3-elevated:#ffffff;        /* thẻ nổi */
    }
    @media (prefers-color-scheme: dark){
      :root{
        --m3-surface:#1b1028;
        --m3-on-surface:#efe7f7;
        --m3-surface-variant:#27183b;
        --m3-outline:#4e2f78;
        --m3-elevated:#221433;
      }
    }

    html,body{margin:0;padding:0;background:var(--m3-surface);color:var(--m3-on-surface);
      font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 6px;font-weight:700;letter-spacing:.1px}
    .subtitle{margin:0 0 16px;color:color-mix(in oklab, var(--m3-on-surface) 72%, transparent)}
    .chip{display:inline-block;padding:2px 10px;border-radius:999px;background:var(--m3-surface-variant);
      border:1px solid var(--m3-outline);color:var(--m3-on-surface);font-size:12px}

    /* hero strip */
    .hero{
      height:56px;margin:0 0 14px;border-radius:18px;
      background:
        radial-gradient(120px 60px at left 40px top -10px, var(--m3-primary) 30%, transparent 31%),
        linear-gradient(90deg, var(--m3-surface-variant), var(--m3-surface));
      border:1px solid var(--m3-outline);
    }

    .card{background:var(--m3-elevated);border:1px solid var(--m3-outline);
      border-radius:18px;box-shadow:0 8px 20px var(--m3-shadow);padding:10px}

    /* table */
    .table-wrap{overflow-x:auto;border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:780px}
    thead th{
      text-align:left;font-weight:700;color:var(--m3-on-surface);
      padding:12px 10px;border-bottom:2px solid var(--m3-outline);
      background:linear-gradient(0deg,var(--m3-surface-variant),var(--m3-surface-variant));
      position:sticky;top:0;z-index:1;
    }
    tbody td{padding:12px 10px;border-bottom:1px dashed var(--m3-outline);vertical-align:top}
    tbody tr:hover{background:color-mix(in oklab, var(--m3-surface-variant) 35%, transparent)}
    .title{font-weight:650}
    .author{color:color-mix(in oklab, var(--m3-on-surface) 70%, transparent)}
    .mono{font-variant-numeric:tabular-nums}
    .nowrap{white-space:nowrap}

    /* rating pill */
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--m3-outline)}
    .pill.pri{background:var(--m3-primary);color:var(--m3-on-primary);border-color:transparent}

    /* header row info */
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 4px 8px}
    .count{color:color-mix(in oklab, var(--m3-on-surface) 70%, transparent)}

    /* responsive: ẩn bớt cột trên mobile, tăng hit area */
    @media (max-width: 840px){
      table{min-width:640px}
      .col-publisher,.col-avg{display:none}
      h1{font-size:22px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero"></div>
    <h1>Danh mục Goodreads <span id="count" class="count"></span></h1>
    <p class="subtitle">
      Cột hiển thị: <span class="chip">Title</span> <span class="chip">Author</span>
      <span class="chip">My Rating</span> <span class="chip">Average Rating</span>
      <span class="chip">Publisher</span> <span class="chip">Date Read (mm-yyyy)</span>
      <span class="chip">Exclusive Shelf</span> <span class="chip">My Review (50 chữ)</span>
    </p>

    <div class="card">
      <div class="toolbar">
        <div class="count" id="status">Đang tải CSV…</div>
      </div>
      <div class="table-wrap">
        <table id="table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Author</th>
              <th class="col-publisher">Publisher</th>
              <th class="nowrap">Date Read</th>
              <th class="nowrap">Exclusive Shelf</th>
              <th class="nowrap">My Rating</th>
              <th class="nowrap col-avg">Average Rating</th>
              <th>My Review (50 chữ)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* ==== CONFIG ==== */
    const CSV_PATH = "goodreads_library_export.csv"; // cùng thư mục
    const REVIEW_WORD_LIMIT = 50;
    const ONLY_READ = false; // đặt true nếu muốn chỉ hiện "read"

    /* ==== HELPERS ==== */
    const $ = s => document.querySelector(s);

    function formatMonthYear(raw){
      if(!raw) return "";
      const s = String(raw).trim();
      let y,m;
      const m1 = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
      const m2 = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      const m3 = s.match(/^(\d{4})[\/\-](\d{1,2})$/);
      const m4 = s.match(/^(\d{4})$/);
      if(m1){y=+m1[1];m=+m1[2];}
      else if(m2){y=+m2[3];m=+m2[1];}
      else if(m3){y=+m3[1];m=+m3[2];}
      else if(m4){y=+m4[1];m=1;}
      else return "";
      return String(m).padStart(2,"0")+"-"+y;
    }
    function clipWords(str,maxWords){
      if(!str) return "";
      const clean = String(str).replace(/\s+/g," ").trim();
      const words = clean.split(" ");
      return words.length<=maxWords?clean:words.slice(0,maxWords).join(" ")+"…";
    }

    function normalizeRow(row){
      return {
        Title: row["Title"] ?? "",
        Author: row["Author"] ?? "",
        Publisher: row["Publisher"] ?? "",
        "Date Read": formatMonthYear(row["Date Read"] ?? ""),
        "Exclusive Shelf": row["Exclusive Shelf"] ?? "",
        "My Rating": row["My Rating"] ?? "",
        "Average Rating": row["Average Rating"] ?? "",
        "My Review": clipWords(row["My Review"] ?? "", REVIEW_WORD_LIMIT),
        __fullReview: row["My Review"] ?? ""
      };
    }

    function renderTable(rows){
      const tbody = $("#table tbody");
      tbody.innerHTML = "";
      const frag = document.createDocumentFragment();

      rows.forEach(r=>{
        const tr = document.createElement("tr");

        const tdTitle = document.createElement("td");
          const t = document.createElement("div"); t.className="title"; t.textContent = r.Title;
          const a = document.createElement("div"); a.className="author"; a.textContent = r.Author;
          tdTitle.append(t,a);
        tr.appendChild(tdTitle);

        const tdAuthor = document.createElement("td"); tdAuthor.textContent = r.Author; tr.appendChild(tdAuthor);

        const tdPub = document.createElement("td"); tdPub.className="col-publisher"; tdPub.textContent = r.Publisher; tr.appendChild(tdPub);

        const tdDate = document.createElement("td"); tdDate.className="nowrap mono"; tdDate.textContent = r["Date Read"]; tr.appendChild(tdDate);

        const tdShelf = document.createElement("td"); tdShelf.className="nowrap"; tdShelf.textContent = r["Exclusive Shelf"]; tr.appendChild(tdShelf);

        const tdMy = document.createElement("td"); tdMy.className="nowrap mono"; tdMy.innerHTML = `<span class="pill pri">${r["My Rating"]||"–"}</span>`; tr.appendChild(tdMy);

        const tdAvg = document.createElement("td"); tdAvg.className="nowrap mono col-avg"; tdAvg.innerHTML = `<span class="pill">${r["Average Rating"]||"–"}</span>`; tr.appendChild(tdAvg);

        const tdRv = document.createElement("td"); tdRv.textContent = r["My Review"]; if(r.__fullReview && r.__fullReview.length>tdRv.textContent.length){ tdRv.title = r.__fullReview; }
        tr.appendChild(tdRv);

        frag.appendChild(tr);
      });

      tbody.appendChild(frag);
      const count = rows.length ? `(${rows.length} sách)` : "(0)";
      $("#count").textContent = " " + count;
      $("#status").textContent = "Đã tải xong.";
    }

    function loadCSV(){
      Papa.parse(CSV_PATH,{
        download:true, header:true, skipEmptyLines:true,
        complete: (res)=>{
          let rows = res.data.map(normalizeRow);
          if(ONLY_READ) rows = rows.filter(r => String(r["Exclusive Shelf"]).trim().toLowerCase()==="read");
          renderTable(rows);
        },
        error: (err)=>{
          console.error(err);
          $("#status").textContent = "Không tải được CSV. Kiểm tra đường dẫn/ghi đè tên file nhé.";
        }
      });
    }
    window.addEventListener("DOMContentLoaded", loadCSV);
  </script>
</body>
</html>
