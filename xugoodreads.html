<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Goodreads → Danh mục</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* ==== Matcha Theme (light & dark) ==== */
    :root{
      /* matcha light */
      --pri:#41a37c;           /* lá matcha tươi */
      --on-pri:#ffffff;
      --surface:#eaf6f0;       /* nền trà sữa nhạt */
      --on-surface:#0e1f18;    /* mực xanh đậm */
      --surface-var:#d5efe3;   /* lớp phụ */
      --outline:#a9dcc6;       /* viền nhạt xanh */
      --elevated:#ffffff;      /* thẻ nổi */
      --shadow:0 8px 18px rgba(10,60,40,.12);
      --shadow-sm:0 6px 14px rgba(10,60,40,.10);
      --hover: color-mix(in oklab, var(--surface-var) 45%, transparent);
    }
    @media (prefers-color-scheme: dark){
      :root{
        /* matcha dark */
        --pri:#3fb586;
        --on-pri:#072218;
        --surface:#0e1713;
        --on-surface:#e7f5ee;
        --surface-var:#12201a;
        --outline:#1f3c30;
        --elevated:#121f19;
        --shadow:0 8px 18px rgba(0,0,0,.35);
        --shadow-sm:0 6px 14px rgba(0,0,0,.32);
        --hover: color-mix(in oklab, var(--surface-var) 65%, transparent);
      }
    }

    html,body{
      margin:0; padding:0; background:var(--surface); color:var(--on-surface);
      font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial
    }
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 6px;font-weight:700}
    .subtitle{margin:0 0 16px;color:color-mix(in oklab, var(--on-surface) 72%, transparent)}
    .chip{display:inline-block;padding:2px 10px;border-radius:999px;background:var(--surface-var);
      border:1px solid var(--outline);color:var(--on-surface);font-size:12px}

    /* hero */
    .hero{
      height:56px;margin:0 0 14px;border-radius:18px;
      background:
        radial-gradient(120px 60px at left 40px top -10px, var(--pri) 32%, transparent 33%),
        linear-gradient(90deg, var(--surface-var), var(--surface));
      border:1px solid var(--outline);
      box-shadow: var(--shadow-sm);
    }

    .card{background:var(--elevated);border:1px solid var(--outline);
      border-radius:18px;box-shadow:var(--shadow);padding:12px}

    .count{color:color-mix(in oklab, var(--on-surface) 70%, transparent)}

    /* ======= TABLE (desktop) ======= */
    .table-wrap{overflow-x:auto;border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:780px}
    thead th{
      text-align:left;font-weight:700;color:var(--on-surface);
      padding:12px 10px;border-bottom:2px solid var(--outline);
      background:linear-gradient(0deg,var(--surface-var),var(--surface-var));
      position:sticky;top:0;z-index:1;
    }
    tbody td{padding:12px 10px;border-bottom:1px dashed var(--outline);vertical-align:top}
    tbody tr:hover{background:var(--hover)}
    .title{font-weight:650}
    .author{color:color-mix(in oklab, var(--on-surface) 70%, transparent)}
    .mono{font-variant-numeric:tabular-nums}
    .nowrap{white-space:nowrap}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--outline)}
    .pill.pri{background:var(--pri);color:var(--on-pri);border-color:transparent}
    .desktop-only{display:block}
    .mobile-only{display:none}

    /* ======= CARDS (mobile) ======= */
    .cards{display:grid;grid-template-columns:1fr;gap:18px}          /* tăng gap để hết “dính chùm” */
    .book{
      background:var(--elevated);border:1px solid var(--outline);border-radius:18px;
      padding:14px 14px 12px;box-shadow:var(--shadow);                /* bóng rõ hơn để tách lớp */
    }
    .book h3{margin:0 0 6px;font-size:17px;line-height:1.35}
    .book .meta{display:flex;flex-wrap:wrap;gap:8px 10px;align-items:center;margin:8px 0 8px}
    .badge{font-size:12px;border:1px solid var(--outline);border-radius:999px;padding:3px 9px}
    .badge.pri{background:var(--pri);color:var(--on-pri);border-color:transparent}
    .muted{color:color-mix(in oklab, var(--on-surface) 65%, transparent)}
    .kv{display:grid;grid-template-columns:auto 1fr;gap:4px 12px;margin:4px 0 8px}
    .kv .k{color:color-mix(in oklab, var(--on-surface) 70%, transparent)}
    .review{margin-top:6px}

    /* breakpoint */
    @media (max-width: 720px){
      .desktop-only{display:none}
      .mobile-only{display:block}
      h1{font-size:22px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero"></div>
    <h1>Danh mục Goodreads <span id="count" class="count"></span></h1>
    <p class="subtitle">
      Cột hiển thị: <span class="chip">Title</span> <span class="chip">Author</span>
      <span class="chip">My Rating</span> <span class="chip">Average Rating</span>
      <span class="chip">Publisher</span> <span class="chip">Date Read (mm-yyyy)</span>
     <span class="chip">My Review (50 chữ)</span>
    </p>

    <div class="card">
      <div class="count" id="status">Đang tải CSV…</div>

      <!-- Desktop table -->
      <div class="table-wrap desktop-only">
        <table id="table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Author</th>
              <th class="col-publisher">Publisher</th>
              <th class="nowrap">Date Read</th>
              <th class="nowrap">My Rating</th>
              <th class="nowrap col-avg">Average Rating</th>
              <th>My Review (50 chữ)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Mobile cards -->
      <div id="cards" class="cards mobile-only"></div>
    </div>
  </div>

  <script>
    /* ==== CONFIG ==== */
    const CSV_PATH = "goodreads_library_export.csv";
    const REVIEW_WORD_LIMIT = 50;
    const ONLY_READ = true;

    /* ==== HELPERS ==== */
    const $ = s => document.querySelector(s);

    function formatMonthYear(raw){
      if(!raw) return "";
      const s = String(raw).trim();
      let y,m;
      const m1 = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
      const m2 = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      const m3 = s.match(/^(\d{4})[\/\-](\d{1,2})$/);
      const m4 = s.match(/^(\d{4})$/);
      if(m1){y=+m1[1];m=+m1[2];}
      else if(m2){y=+m2[3];m=+m2[1];}
      else if(m3){y=+m3[1];m=+m3[2];}
      else if(m4){y=+m4[1];m=1;}
      else return "";
      return String(m).padStart(2,"0")+"-"+y;
    }
    function clipWords(str,maxWords){
      if(!str) return "";
      const clean = String(str).replace(/\s+/g," ").trim();
      const words = clean.split(" ");
      return words.length<=maxWords?clean:words.slice(0,maxWords).join(" ")+"…";
    }

    function normalizeRow(row){
      return {
        Title: row["Title"] ?? "",
        Author: row["Author"] ?? "",
        Publisher: row["Publisher"] ?? "",
        "Date Read": formatMonthYear(row["Date Read"] ?? ""),
        "My Rating": row["My Rating"] ?? "",
        "Exclusive Shelf": row["Exclusive Shelf"] ?? "",
        "Average Rating": row["Average Rating"] ?? "",
        "My Review": clipWords(row["My Review"] ?? "", REVIEW_WORD_LIMIT),
        __fullReview: row["My Review"] ?? ""
      };
    }

    /* table (desktop) */
    function renderTable(rows){
      const tbody = $("#table tbody"); if(!tbody) return;
      tbody.innerHTML = "";
      const frag = document.createDocumentFragment();

      rows.forEach(r=>{
        const tr = document.createElement("tr");

        const tdTitle = document.createElement("td");
          const t = document.createElement("div"); t.className="title"; t.textContent = r.Title;
          const a = document.createElement("div"); a.className="author"; a.textContent = r.Author;
          tdTitle.append(t,a);
        tr.appendChild(tdTitle);

        const tdAuthor = document.createElement("td"); tdAuthor.textContent = r.Author; tr.appendChild(tdAuthor);

        const tdPub = document.createElement("td"); tdPub.className="col-publisher"; tdPub.textContent = r.Publisher; tr.appendChild(tdPub);

        const tdDate = document.createElement("td"); tdDate.className="nowrap mono"; tdDate.textContent = r["Date Read"]; tr.appendChild(tdDate);

        const tdMy = document.createElement("td"); tdMy.className="nowrap mono"; tdMy.innerHTML = `<span class="pill pri">${r["My Rating"]||"–"}</span>`; tr.appendChild(tdMy);

        const tdAvg = document.createElement("td"); tdAvg.className="nowrap mono col-avg"; tdAvg.innerHTML = `<span class="pill">${r["Average Rating"]||"–"}</span>`; tr.appendChild(tdAvg);

        const tdRv = document.createElement("td"); tdRv.textContent = r["My Review"]; if(r.__fullReview && r.__fullReview.length>tdRv.textContent.length){ tdRv.title = r.__fullReview; }
        tr.appendChild(tdRv);

        frag.appendChild(tr);
      });

      tbody.appendChild(frag);
    }

    /* cards (mobile) */
    function renderCards(rows){
      const container = $("#cards"); if(!container) return;
      container.innerHTML = "";
      const frag = document.createDocumentFragment();

      rows.forEach(r=>{
        const card = document.createElement("article");
        card.className = "book";

        const h3 = document.createElement("h3"); h3.textContent = r.Title; card.appendChild(h3);
        const author = document.createElement("div"); author.className = "muted"; author.textContent = r.Author; card.appendChild(author);

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <span class="badge pri">My ★ ${r["My Rating"] || "–"}</span>
          <span class="badge">Avg ★ ${r["Average Rating"] || "–"}</span>
        `;
        card.appendChild(meta);

        const kv = document.createElement("div");
        kv.className = "kv";
        kv.innerHTML = `
          <div class="k">Publisher</div><div>${r.Publisher || "—"}</div>
          <div class="k">Date Read</div><div>${r["Date Read"] || "—"}</div>
        `;
        card.appendChild(kv);

        const review = document.createElement("div");
        review.className = "review";
        review.textContent = r["My Review"] || "";
        if (r.__fullReview && r.__fullReview.length > review.textContent.length) {
          review.title = r.__fullReview;
        }
        card.appendChild(review);

        frag.appendChild(card);
      });

      container.appendChild(frag);
    }

    function loadCSV(){
      Papa.parse(CSV_PATH,{
        download:true, header:true, skipEmptyLines:true,
        complete: (res)=>{
          let rows = res.data.map(normalizeRow);
          if(ONLY_READ) rows = rows.filter(r => String(r["Exclusive Shelf"]).trim().toLowerCase()==="read");
          renderTable(rows);   // desktop
          renderCards(rows);   // mobile
          $("#count").textContent = ` (${rows.length} sách)`;
          $("#status").textContent = "Đã tải xong.";
        },
        error: (err)=>{
          console.error(err);
          $("#status").textContent = "Không tải được CSV. Kiểm tra đường dẫn/ghi đè tên file nhé.";
        }
      });
    }
    window.addEventListener("DOMContentLoaded", loadCSV);
  </script>
</body>
</html>
