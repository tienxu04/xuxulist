<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Goodreads → Danh mục</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#0b0c0f; --card:#12141a; --text:#e9eef5; --muted:#aab4c3; --border:#1e2230; --zebra:#151923; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px}
    .small{color:var(--muted);margin-bottom:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:var(--card);z-index:1;text-align:left;font-weight:600;color:var(--muted);border-bottom:1px solid var(--border);padding:10px 8px}
    tbody td{padding:10px 8px;vertical-align:top;border-bottom:1px dashed var(--border)}
    tbody tr:nth-child(odd){background:var(--zebra)}
    .mono{font-variant-numeric:tabular-nums}
    .nowrap{white-space:nowrap}
    .title{font-weight:600}
    .author{color:var(--muted)}
    .count{color:var(--muted);margin-left:8px}
    @media (max-width:840px){.hide-md{display:none}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Danh mục Goodreads <span id="count" class="count"></span></h1>
    <div class="small">Cột hiển thị: Id, Title, Author, My Rating, Average Rating, Publisher, Date Read (mm-yyyy), Exclusive Shelf, My Review (50 chữ đầu).</div>
    <div class="card">
      <table id="table">
        <thead>
          <tr>
            <th class="nowrap">Id</th>
            <th>Title</th>
            <th>Author</th>
            <th class="hide-md">Publisher</th>
            <th class="nowrap">Date Read</th>
            <th class="nowrap">Exclusive Shelf</th>
            <th class="nowrap">My Rating</th>
            <th class="nowrap">Average Rating</th>
            <th>My Review (50 chữ)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // ==== Config ====
    const CSV_PATH = "goodreads_library_export.csv"; // cùng folder với index.html
    const REVIEW_WORD_LIMIT = 50;
    const ONLY_READ = true; // đặt true nếu muốn chỉ hiện shelf = "read"

    // ==== Helpers ====
    const $ = s => document.querySelector(s);
    function formatMonthYear(raw) {
      if (!raw) return "";
      const s = String(raw).trim();
      let y, m;
      const m1 = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/); // YYYY/MM/DD
      const m2 = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/); // MM/DD/YYYY hoặc DD/MM/YYYY
      const m3 = s.match(/^(\d{4})[\/\-](\d{1,2})$/);                // YYYY/MM
      const m4 = s.match(/^(\d{4})$/);                              // YYYY
      if (m1) { y = +m1[1]; m = +m1[2]; }
      else if (m2) { y = +m2[3]; m = +m2[1]; }
      else if (m3) { y = +m3[1]; m = +m3[2]; }
      else if (m4) { y = +m4[1]; m = 1; }
      else return "";
      return String(m).padStart(2,"0") + "-" + y;
    }
    function clipWords(str, maxWords) {
      if (!str) return "";
      const clean = String(str).replace(/\s+/g," ").trim();
      const words = clean.split(" ");
      return words.length <= maxWords ? clean : words.slice(0,maxWords).join(" ") + "…";
    }
    function normalizeRow(row) {
      return {
        Id: row["Book Id"] ?? "",
        Title: row["Title"] ?? "",
        Author: row["Author"] ?? "",
        "My Rating": row["My Rating"] ?? "",
        "Average Rating": row["Average Rating"] ?? "",
        Publisher: row["Publisher"] ?? "",
        "Date Read": formatMonthYear(row["Date Read"] ?? ""),
        "Exclusive Shelf": row["Exclusive Shelf"] ?? "",
        "My Review": clipWords(row["My Review"] ?? "", REVIEW_WORD_LIMIT),
        __fullReview: row["My Review"] ?? ""
      };
    }
    function renderTable(rows) {
      const tbody = $("#table tbody");
      tbody.innerHTML = "";
      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td"); tdId.className="mono nowrap"; tdId.textContent = r.Id; tr.appendChild(tdId);
        const tdTitle = document.createElement("td");
          const t = document.createElement("div"); t.className="title"; t.textContent = r.Title;
          const a = document.createElement("div"); a.className="author"; a.textContent = r.Author;
          tdTitle.append(t,a); tr.appendChild(tdTitle);
        const tdAuthor = document.createElement("td"); tdAuthor.textContent = r.Author; tr.appendChild(tdAuthor);
        const tdPub = document.createElement("td"); tdPub.className="hide-md"; tdPub.textContent = r.Publisher; tr.appendChild(tdPub);
        const tdDate = document.createElement("td"); tdDate.className="nowrap mono"; tdDate.textContent = r["Date Read"]; tr.appendChild(tdDate);
        const tdShelf = document.createElement("td"); tdShelf.className="nowrap"; tdShelf.textContent = r["Exclusive Shelf"]; tr.appendChild(tdShelf);
        const tdMy = document.createElement("td"); tdMy.className="nowrap mono"; tdMy.textContent = r["My Rating"]; tr.appendChild(tdMy);
        const tdAvg = document.createElement("td"); tdAvg.className="nowrap mono"; tdAvg.textContent = r["Average Rating"]; tr.appendChild(tdAvg);
        const tdRv = document.createElement("td"); tdRv.textContent = r["My Review"]; if (r.__fullReview && r.__fullReview.length > tdRv.textContent.length) tdRv.title = r.__fullReview; tr.appendChild(tdRv);

        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
      $("#count").textContent = rows.length ? `(${rows.length} sách)` : "(0)";
    }

    // ==== Load & parse from local CSV ====
    function loadCSV() {
      Papa.parse(CSV_PATH, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          let rows = res.data.map(normalizeRow);
          if (ONLY_READ) rows = rows.filter(r => String(r["Exclusive Shelf"]).toLowerCase().trim() === "read");
          renderTable(rows);
        },
        error: (err) => {
          console.error("CSV parse error:", err);
          $("#count").textContent = "(lỗi tải CSV)";
        }
      });
    }

    window.addEventListener("DOMContentLoaded", loadCSV);
  </script>
</body>
</html>
